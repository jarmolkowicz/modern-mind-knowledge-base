name: Build KB Bundle

on:
  push:
    branches: [main]
    paths:
      - 'concepts/**'
      - 'frameworks/**'
      - 'practices/**'
      - 'sources/**'

  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build concatenated KB file
        run: bash scripts/build-bundle.sh

      - name: Get bundle stats
        id: stats
        run: |
          CONCEPTS=$(ls concepts/*.md 2>/dev/null | wc -l | tr -d ' ')
          FRAMEWORKS=$(ls frameworks/*.md 2>/dev/null | wc -l | tr -d ' ')
          PRACTICES=$(ls practices/*.md 2>/dev/null | wc -l | tr -d ' ')
          SOURCES=$(ls sources/*.md 2>/dev/null | wc -l | tr -d ' ')
          TOTAL=$((CONCEPTS + FRAMEWORKS + PRACTICES + SOURCES))
          DATE=$(date +%Y.%m.%d)

          echo "concepts=$CONCEPTS" >> "$GITHUB_OUTPUT"
          echo "frameworks=$FRAMEWORKS" >> "$GITHUB_OUTPUT"
          echo "practices=$PRACTICES" >> "$GITHUB_OUTPUT"
          echo "sources=$SOURCES" >> "$GITHUB_OUTPUT"
          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "tag=v$DATE" >> "$GITHUB_OUTPUT"

      - name: Delete existing release for today
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete "${{ steps.stats.outputs.tag }}" --yes 2>/dev/null || true
          git push --delete origin "${{ steps.stats.outputs.tag }}" 2>/dev/null || true

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.stats.outputs.tag }}" \
            dist/modern-mind-kb.md \
            --title "Knowledge Base — ${{ steps.stats.outputs.date }}" \
            --notes "$(cat <<'EOF'
          ## What's in this release

          A single markdown file containing the full Modern Mind Knowledge Base. Download it and upload to your AI tool of choice.

          ### Contents
          - **${{ steps.stats.outputs.concepts }}** concepts
          - **${{ steps.stats.outputs.frameworks }}** frameworks
          - **${{ steps.stats.outputs.practices }}** practices
          - **${{ steps.stats.outputs.sources }}** sources
          - **${{ steps.stats.outputs.total }}** entries total

          ### How to use it
          - **Claude Projects** — Create a new project, upload `modern-mind-kb.md` as project knowledge
          - **NotebookLM** — Upload the file directly as a source
          - **Custom GPTs** — Upload to the knowledge section of your Custom GPT
          - **Any LLM** — Paste relevant sections into your conversation for grounded answers

          Built automatically from the latest commit on `main`.
          EOF
          )"
